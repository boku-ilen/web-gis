{% load leaflet_tags %}
{% load static %}
<html>
    <body>
      <div class="row h-100 d-flex justify-content-center">
        <div class="col-sm-12 col-md-7">
          {% leaflet_map "entry"  %}
        </div>
        <div class="col-sm-12 col-md-5">
          <div class="mx-3 mx-md-0 pb-3 pb-md-0">
            <h1>Neuer Eintrag</h1>
            <!-- Only show dropdown options if there are actually options to choose from -->
            {% if entry_definitions|length > 1 %}
            <select name="entryDefs" id="entryDefs" onchange="loadReflections(getIdFromHtml())">
              {% for entry_def in entry_definitions %}
              <option value="{{ entry_def.id }}">{{ entry_def.name }}</option>
              {% endfor %}
            </select>
            {% endif %}
            <div>
              <form id="entry-form">
              </form>
            </div>
            <hr>
            <button class="btn btn-outline-primary" onclick="createEntry()">Absenden</button>
          </div>
        </div>
      </div>
    </body>
  <head>
    {% leaflet_js %}
    {% leaflet_css %}
    <link rel="stylesheet" href="{% static 'global.css' %}">
    <link rel="stylesheet" href="{% static 'entry.css' %}">
    <link rel="stylesheet" href="{% static 'bootstrap-5.3.2-dist/css/bootstrap.min.css' %}">
    <script src="{% static 'bootstrap-5.3.2-dist/css/bootstrap.min.css' %}"></script>
    <script src="{% static 'ui_reflections.js' %}"></script>
    <script>

      // Get the field definitions of current entry definition using the pk(id) from HTML
      function getIdFromHtml() {
        return document.getElementById("entryDefs").value
      }

      function createEntry() {
        var formData = new FormData(document.getElementById("entry-form"));
        
        var field_data = {};
        formData.forEach((_, key) => field_data[key] = formData.getAll(key));

        var object = {
          "project": "{{ project_url }}",
          "definition": document.getElementById("entry-form").getAttribute("definitionid"),
          "field_data": field_data,
          "geom": marker.toGeoJSON()
        };
        var json = JSON.stringify(object);

        const request = new XMLHttpRequest();
        request.open("POST", "/{{ project_url }}/create/");
        request.setRequestHeader("X-CSRFTOKEN", "{{ csrf_token }}")
        // TODO: React to a unsuccessful response (e.g. a popup?)
        request.onload = () => location.href = "/{{ project_url }}/"
        request.onerror = () => alert("Etwas ist schief gelaufen, bitte probiere es spÃ¤ter erneut.");
        request.send(json);
      }

      let entryDefinitions = JSON.parse('{{ entry_definitions_js|escapejs }}')
      function loadReflections(entryDefPk) {
        // Clear form from possible previous selection
        let form = document.getElementById('entry-form');
        form.replaceChildren();
        form.setAttribute("definitionid", entryDefPk) 
               
        // Obtain currently selected entry-definiton
        let entryDef = entryDefinitions.filter((entryDef) => {return entryDef.pk == entryDefPk})[0]
        
        // Get the field definition
        let fieldDef = entryDef.fields.field_definition

        // for each field in entry def load the gui
        for (field_name in fieldDef) {
          const type = fieldDef[field_name].type
          const params = fieldDef[field_name].params 
          const gui_elements = type_gui_reflections[type](field_name, params)
                    
          form.appendChild(gui_elements["label"])
          form.appendChild(gui_elements["input"])
        }
      }

      // Initial load
      loadReflections(entryDefinitions[0].pk)
      // Load the marker from the url params
      var marker
      const pinIcon = L.icon({
        iconUrl: "{% static 'res/map-pin.svg' %}",
        iconSize:     [35, 35], // size of the icon
        iconAnchor:   [35 / 2, 35], // point of the icon which will correspond to marker's location
      });
      window.addEventListener("map:init", function (event) {
        var map = event.detail.map;
        // Zoom to and add marker
        marker = new L.Marker(["{{ lat }}", "{{ lon }}"], {icon: pinIcon});
        marker.addTo(map);

        map.flyTo(new L.LatLng("{{ lat }}", "{{ lon }}"), 16, {"animate": false});
        
        // Add click event for updating the marker 
        map.on('click', function(e) { marker.setLatLng(e.latlng); });
      });
    </script>
  </head>
</html>
